/**
 * API Bound Models for AngularJS
 * @version v0.3.1 - 2013-10-17
 * @link https://github.com/angular-platanus/angular-restmod
 * @author Ignacio Baixas <iobaixas@gmai.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){"use strict";a.module("plRestmod",["ng"]),a.module("plRestmod").factory("ModelBuilder",["$injector","$parse","$filter","Utils","SyncMask",function(b,c,d,e,f){function g(a,b){return a?function(c){return b.call(this,a.call(this,c))}:b}function h(a,b){return a?function(){var c=this.$super;try{return this.$super=a,b.apply(this,arguments)}finally{this.$super=c}}:b}function i(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=h(a[c],b[c]))}function j(a){return b.get(e.camelcase(a)+"Serializer")}var k=a.bind,l=a.forEach,m=a.isFunction,n=a.isObject;return function(a){var o={primary:["attrPrimary"],init:["attrDefault"],ignore:["attrIgnored"],decode:["attrDecoder","param","chain"],encode:["attrEncoder","param","chain"],type:["attrSerializer"],hasMany:["hasMany","alias"],hasOne:["hasOne","alias"]};return{extend:function(a,b,c){return"string"==typeof a?(this[a]=h(this[name],b),c&&(o[c[0]]=c,c[0]=a)):i(this,a),this},describe:function(a){return l(a,function(a,b){n(a)?this.attribute(b,a):m(a)?this.define(b,a):this.attrDefault(b,a)},this),this},attribute:function(a,b){var c,d,e,f;for(c in b)if(b.hasOwnProperty(c)&&(d=o[c])){for(e=[a,b[c]],f=1;f<d.length;f++)e.push(b[d[f]]);e.push(b),this[d[0]].apply(this,e)}return this},attrPrimary:function(b,c){return c&&a.urlBuilder.addPrimaryKey(b),this},attrDefault:function(b,c){return a.defaults.push([b,c]),this},attrIgnored:function(b,c,d){return c===!0?a.masks[b]=f.ALL:c===!1?delete a.masks[b]:d?a.masks[b]=c:a.masks[b]|=c,this},attrSerializer:function(a,b,c){return"string"==typeof b&&(b=j(b)),m(b)&&(b=b(c)),b.decode&&this.attrDecoder(a,k(b,b.decode)),b.encode&&this.attrEncoder(a,k(b,b.encode)),this},attrDecoder:function(b,c,e,f){if("string"==typeof c){var h=d(c);c=function(a){return h(a,e)}}return a.decoders[b]=f?g(a.decoders[b],c):c,this},attrEncoder:function(b,c,e,f){if("string"==typeof c){var h=d(c);c=function(a){return h(a,e)}}return a.encoders[b]=f?g(a.encoders[b],c):c,this},hasMany:function(a,c,d){return this.attrDefault(a,function(){return"string"==typeof c&&(c=b.get(c)),c.$collection(null,d||e.snakecase(a,"-"),this)}).attrDecoder(a,function(b){this[a].$feed(b)})},hasOne:function(a,c,d){return this.attrDefault(a,function(){return"string"==typeof c&&(c=b.get(c)),new c(null,d||e.snakecase(a,"-"),this)}).attrDecoder(a,function(b){this[a].$decode(b)})},define:function(b,c){return"string"==typeof b?a.objectProto[b]=h(a.objectProto[b],c):i(a.objectProto,b),this},classDefine:function(b,c){return"string"==typeof b?a.classProto[b]=h(a.classProto[b],c):i(a.classProto,b),this},on:function(b,c){var d=a.callbacks[b];return d||(d=a.callbacks[b]=[]),d.push(c),this},beforeSave:function(a){return this.on("before_save",a)},beforeCreate:function(a){return this.on("before_create",a)},afterCreate:function(a){return this.on("after_create",a)},beforeUpdate:function(a){return this.on("before_update",a)},afterUpdate:function(a){return this.on("after_update",a)},afterSave:function(a){return this.on("after_save",a)},beforeDestroy:function(a){return this.on("before_destroy",a)},afterDestroy:function(a){return this.on("after_destroy",a)},afterFeed:function(a){return this.on("after_feed",a)},beforeRender:function(a){return this.on("before_render",a)},attrVolatile:function(a,b){return this.attrDefault(a,b).attrEncoder(a,function(c){return this[a]=m(b)?b.call(this):b,c},null,!0)},attrExpression:function(a,b){var d=c(b);this.on("after_feed",function(){this[a]=d(this)})}}}}]),a.module("plRestmod").constant("RestUrlBuilderFactory",function(){return function(a,c){return function(d){return c&&(d=c+"/"+d),{setPrimaryKey:function(b){a=b},inferKey:function(){return a},resourceUrl:function(c){var e,f=c.$partial;if(!f){if(e=c[a],null===e||e===b)return null;if(d)return d+"/"+e}if(c.$context){var g=c.$context.$url();return g?g+"/"+(f||e):null}return f||null},collectionUrl:function(a){if(a.$context){var b=a.$context.$url();return b?a.$partial?b+"/"+a.$partial:b:null}return a.$partial?a.$partial:d},createUrl:function(a){return a.$context?a.$context.$url():d},updateUrl:function(a){return this.resourceUrl(a)},destroyUrl:function(a){return this.resourceUrl(a)}}}}}());var c=a.noop;a.module("plRestmod").constant("Utils",{camelcase:function(a){return"string"!=typeof a?a:a.replace(/_[\w\d]/g,function(a,b,c){return 0===b?a:c.charAt(b+1).toUpperCase()})},snakecase:function(a,b){return"string"!=typeof a?a:a.replace(/[A-Z]/g,function(a,c){return 0===c?a:(b||"_")+a.toLowerCase()})}}).constant("SyncMask",{NONE:0,ALL:65535,DECODE_CREATE:1,DECODE_UPDATE:2,DECODE_USER:4,DECODE_SAVE:3,ENCODE_CREATE:256,ENCODE_UPDATE:512,ENCODE_USER:1024,ENCODE_SAVE:768,DECODE:255,ENCODE:65280,CREATE:257,UPDATE:514,USER:1028,SAVE:771}).provider("$restmod",["Utils","SyncMask",function(d,e){var f,g,h=a.forEach,i=a.extend,j=a.isObject,k=a.isArray,l=Array.prototype.slice,m=d.camelcase,n=d.snakecase,o=[];return{pushModelBase:function(){return Array.prototype.push.apply(o,arguments),this},setUrlBuilder:function(a){return f=a,this},setAttributeRenaming:function(a){return a?a===!0?(m=d.camelcase,n=d.snakecase):(m=a.decode,n=a.encode):m=n=null,this},$get:["$http","$q","$injector",function(a,d,p){function q(a,b){if(a.$meta)q(a.$meta,b);else if("string"==typeof a)q(p.get(a),b);else if(k(a))for(var c,d=0;c=a[d++];)q(c,b);else"function"==typeof a?a.call(b,b):b.describe(a)}f||(f=p.get("RestUrlBuilderFactory")("id")),g||(g=p.get("ModelBuilder"));var r=function(p){function r(a,b){var c=z[a];if(c)for(var d,e=0,f=l.call(arguments,2);d=c[e++];)d.apply(b,f)}function s(b,c,e,f){b.$pending=!0,b.$error=!1,b.$promise=a(c).then(function(a){return b.$pending=!1,e&&e.call(b,a),b},function(a){return b.$pending=!1,b.$error=!0,f&&f.call(b,a),d.reject(b)})}var t={},u=t.urlBuilder=j(p)?p:f(p),v=t.masks={$partial:e.ALL,$context:e.ALL,$promise:e.ALL,$pending:e.ALL,$error:e.ALL},w=t.defaults=[],x=t.decoders={},y=t.encoders={},z=t.callbacks={},A=function(a,b,c){this.$pending=!1,this.$partial=b,this.$context=c;for(var d,e=0;d=w[e];e++)this[d[0]]="function"==typeof d[1]?d[1].apply(this):d[1];if(a)for(d in a)a.hasOwnProperty(d)&&(this[d]=a[d])};t.classProto=i(A,{$url:function(){return u.collectionUrl(this)},$build:function(a){var b,d;if(j(a))b=a;else{if(b={},d=u.inferKey(this),!d)throw c("notsup","Cannot infer build key, use explicit mode");b[d]=a}var e=new A(b,null,this);return this.$isCollection&&this.push(e),e},$buildRaw:function(a){return this.$build(null).$decode(a)},$create:function(a,b,c){return this.$build(a).$save(b,c)},$find:function(a,b,d){var e,f;if(j(a))e=a;else{if(e={},f=u.inferKey(this),!f)throw c("notsup","Cannot infer find key, use explicit mode");e[f]=a}return new A(e,null,this).$fetch(b,d)},$collection:function(a,b,c){a=this.$params?i({},this.$params,a):a;var d=[];for(var e in this)this.hasOwnProperty(e)&&(d[e]=this[e]);return d.$partial=b||this.$partial,d.$context=c||this.$context,d.$isCollection=!0,d.$params=a,d.$pending=!1,d.$resolved=!1,d},$search:function(a,b,c){return this.$collection(a).$fetch(b,c)},$then:function(a,b){return this.$isCollection&&(this.$promise=this.$promise.then(a,b)),this},$reset:function(){return this.$isCollection&&(this.$resolved=!1,this.length=0),this},$feed:function(a){return this.$isCollection&&(h(a,this.$buildRaw,this),this.$resolved=!0),this},$fetch:function(a){if(this.$isCollection){var b=a?i({},this.$params||{},a):this.$params;s(this,{method:"GET",url:this.$url(),params:b},function(a){var b=a.data;if(!b||!k(b))throw c("badcfg","Error in resource {0} configuration. Expected response to be array");this.$reset().$feed(b),r("after_collection_fetch",this,a)})}return this}}),t.objectProto=A.prototype={$url:function(){return u.resourceUrl(this)},$callback:function(a){return r(this,a,l.call(arguments,1)),this},$send:function(a,b,c){return s(this,a,b,c),this},$then:function(a,b){return this.$promise=this.$promise.then(a,b),this},$decode:function(a,c){c||(c=e.DECODE_USER);var d,f,g,h,i={};for(d in a)!a.hasOwnProperty(d)||(v[d]||0)&c||(f=m?m(d):d,g=x[f],h=g?g.call(this,a[d]):a[d],h!==b&&(i[f]=this[f]=h));return r("after_feed",this,i,a),this},$encode:function(a){a||(a=e.ENCODE_USER);var b,c,d,f={};for(b in this)!this.hasOwnProperty(b)||(v[b]||0)&a||(c=n?n(b):b,d=y[b],f[c]=d?d.call(this,this[b]):this[b]);return r("before_render",this,f),f},$fetch:function(){if(!this.$url())throw c("notsup","Cannot fetch an unbound resource");return this.$send({method:"GET",url:this.$url(),feed:!0},function(a){var b=a.data;if(!b||k(b))throw c("badresp","Expected object while feeding resource");this.$decode(b)})},$save:function(){var a;if(this.$url()){if(a=u.updateUrl(this),!a)throw c("notsup","Update is not supported by this resource");return r("before_update",this),r("before_save",this),this.$send({method:"PUT",url:a,data:this.$encode(e.ENCODE_CREATE)},function(a){var b=a.data;b&&!k(b)&&this.$decode(b,e.DECODE_UPDATE),r("after_update",this),r("after_save",this)})}if(a=u.createUrl(this),!a)throw c("notsup","Create is not supported by this resource");return r("before_save",this),r("before_create",this),this.$send({method:"POST",url:a,data:this.$encode(e.ENCODE_UPDATE)},function(a){var b=a.data;b&&!k(b)&&this.$decode(b,e.DECODE_CREATE),r("after_create",this),r("after_save",this)})},$destroy:function(){var a=u.destroyUrl(this);if(!a)throw c("notsup","Destroy is not supported by this resource");return r("before_destroy",this),this.$send({method:"DELETE",url:a},function(){r("after_destroy",this)})}},A.$isAbstract=!1,A.$meta=l.call(arguments,1);var B=g(t);return q(o,B),q(A.$meta,B),A};return r.abstract=function(){return{$isAbstract:!0,$meta:l.call(arguments,0)}},r}]}}])}(angular);