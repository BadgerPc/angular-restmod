/**
 * API Bound Models for AngularJS
 * @version v0.1.1 - 2013-09-23
 * @link https://github.com/angular-platanus/angular-restmod
 * @author Ignacio Baixas <iobaixas@gmai.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
var $restmodMinErr=angular.noop;angular.module("plRestmod",["ng"]).provider("$restmod",[function(){function a(a){return h(a)?a.replace(/_[\w\d]/g,function(a,b,c){return 0===b?a:c.charAt(b+1).toUpperCase()}):a}function b(a){return h(a)?a.replace(/[A-Z]/g,function(a,b){return 0===b?a:"_"+a.toLowerCase()}):a}var c=angular.forEach,d=angular.extend,e=angular.isFunction,f=angular.isObject,g=angular.isArray,h=angular.isString,i=Array.prototype.slice,j=function(a){this.primary=a};j.prototype={get:function(a){var b={primary:this.primary};return{setPrimaryKey:function(a){b.primary=a},inferKey:function(){return b.primary},queryUrl:function(){return a},resourceUrl:function(c){var d=c[b.primary];return null===d||void 0===d?null:a?a+"/"+d:c.$context&&c.$context.$url?c.$context.$url+"/"+d:null},createUrl:function(b){return b.$context&&b.$context.$url?b.$context.$url:a},updateUrl:function(a){return a.$url},nestedUrl:function(a,b){return a.$url+"/"+b}}}};var k=new j("id"),l={"rails-date":function(a){if(!a)return a;var b=a.match(/(\d{2,4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);return b?new Date(parseInt(b[1],10),parseInt(b[2],10)-1,parseInt(b[3],10),parseInt(b[4],10),parseInt(b[5],10),parseInt(b[6],10)):(b=a.match(/(\d{2,4})-(\d{2})-(\d{2})/))?new Date(parseInt(b[1],10),parseInt(b[2],10)-1,parseInt(b[3],10)):(b=a.match(/(\d{2,4})\/(\d{2})\/(\d{2})/),b?new Date(parseInt(b[1],10),parseInt(b[2],10)-1,parseInt(b[3],10)):null)}};return{setUrlBuilder:function(a){return k=a,this},addTransformation:function(a,b){return f(a)?d(l,a):l[a]=b,this},addDatatype:function(){},$get:["$http","$q",function(h,j){return function(m){function n(a,b){var c=t[a];if(c)for(var d,e=0,f=i.call(arguments,2);d=c[e++];)d.apply(b,f)}var o=f(m)?m:k.get(m),p={$url:!0,$promise:!0,$resolved:!0,$error:!0,$context:!0,$relcache:!0},q={},r={},s={},t={},u=function(a,b,c){this.$resolved=!0,this.$context=c,this.$url=b;var d,e;for(d in q)q.hasOwnProperty(d)&&(e=q[d],this[d]="function"==typeof e?e.apply(this):e);if(a){for(d in a)a.hasOwnProperty(d)&&(this[d]=a[d]);this.$url||(this.$url=o.resourceUrl(this))}};u.prototype=d({$isBound:function(){return!!this.$url},$callback:function(a){return n(this,a,i.call(arguments,1)),this},$feed:function(b){var c,d,e,f;for(c in b)b.hasOwnProperty(c)&&(d=a(c),e=r[d],f=e?e.call(this,b[c]):b[c],void 0!==f&&(this[d]=f));return n("after_feed",this,b),this.$url||(this.$url=o.resourceUrl(this)),this},$render:function(){var a,c,d,e={};for(a in this)this.hasOwnProperty(a)&&!p[a]&&(c=b(a),d=s[c],e[c]=d?d.call(this,this[a]):this[a]);return n("before_render",this,e),e},$fetch:function(a,b){if(!this.$url)throw $restmodMinErr("notsup","Cannot fetch an unbound resource");return this.$send({method:"GET",url:this.$url,feed:!0},a,b)},$save:function(a,b){if(this.$isBound())n("before_update",this),n("before_save",this),this.$send({method:"PUT",url:this.$url,data:this.$render(),feed:!0},function(b){n("after_update",this),n("after_save",this),a&&a(b)},b);else{var c=o.createUrl(this);if(!c)throw $restmodMinErr("notsup","Create not supported by this resource");n("before_save",this),n("before_create",this),this.$send({method:"POST",url:c,data:this.$render(),feed:!0},function(b){n("after_create",this),n("after_save",this),a&&a(b)},b)}return this},$destroy:function(a,b){return n("before_destroy",this),this.$send({method:"DELETE",url:this.$getUrl()},function(b){n("after_destroy",this),a&&a(b)},b)},$send:function(a,b,c){var d=this;return this.$resolved=!1,this.$error=!1,this.$promise=h(a).then(function(c){if(a.feed){var e=c.data;if(!e||g(e))throw $restmodMinErr("badresp","Expected object while feeding resource");d.$feed(e)}return d.$resolved=!0,c.resource=d,b&&b(c),c},function(a){return d.$resolved=!0,d.$error=!0,c&&c(a),j.reject(a)}),this}}),u.$collection=function(a,b,e){var f=d([],u.collection_proto);return f.$url=a,f.$isCollection=!0,f.$params=b,g(e)?(c(e,f.$buildRaw,f),f.$resolved=!0):f.$resolved=!1,f},u.collection_proto={$fetch:function(a,b,f){e(a)&&(a=null,b=a,f=b);var i=this,k=a?d({},this.$params,a):this.$params;return this.$resolved=!1,this.$error=!1,this.$promise=h({method:"GET",url:this.$url,params:k}).then(function(a){var d=a.data;if(!d||!g(d))throw $restmodMinErr("badcfg","Error in resource {0} configuration. Expected response to be array");return i.length=0,c(d,i.$buildRaw,i),i.$resolved=!0,n("after_collection_fetch",i,a),a.resource=i,b&&b(a),a},function(a){return i.$resolved=!0,i.$error=!0,f&&f(a),j.reject(a)}),this},$fetchMore:function(){}};var v={$build:function(a){var b=new u(a,null,this);return this.$isCollection&&this.push(b),b},$buildRaw:function(a){return this.$build(null).$feed(a)},$create:function(a,b,c){return this.$build(a).$save(b,c)},$find:function(a,b,c){var d,e;if(f(a))d=a;else{if(d={},e=o.inferKey(this),!e)throw $restmodMinErr("notsup","Cannot infer find key, use explicit mode");d[e]=a}return new u(d,null,this).$fetch(b,c)},$buildQuery:function(a){var b,c;if(this.$isCollection)b=this.$url,c=d({},this.$params,a);else{if(b=o.queryUrl(),!b)throw $restmodMinErr("notsup","Collection not supported by resource root");c=a}return u.$collection(b,c)},$search:function(a,b,c){return this.$buildQuery(a).$fetch(b,c)}},w={loadMeta:function(a){if(a.$meta)this.loadMeta(a.$meta);else if(g(a))for(var b,d=0;b=a[d++];)this.loadMeta(b);else e(a)?a.call(this,this):c(a,function(a,b){e(a)?this.define(b,a):a.hasMany?this.hasMany(b,a.hasMany,a):a.hasOne?this.hasOne(b,a.hasOne,a):(a.primary&&o.primary&&this.attrPrimary(b),a.ignore&&this.attrIgnore(b,!0),a.init&&this.attrDefault(b,a.init),a.parse&&this.attrParser(b,a.parse,a),a.render&&this.attrRenderer(b,a.render,a))},this)},attrPrimary:function(a){return o.addPrimaryKey(a),this},attrIgnore:function(a,b){return p[a]=b,this},attrDefault:function(a,b){return q[a]=b,this},attrParser:function(a,b,c){return r[a]=e(b)?b:function(a){return l[b](a,c)},this},attrRenderer:function(a,b,c){return s[a]=e(b)?b:function(a){return l[b](a,c)},this},hasMany:function(a,b,c){return u.prototype[a]=function(d){this.$relcache||(this.$relcache={});var e=this.$relcache[a];if(!e||d){var f=c.url||o.nestedUrl(this,c.alias||a,b,c),h=g(d)?d:null;this.$relcache[a]=e=b.$collection(f,{},h)}return e},r[a]=function(b){this[a](b)},this},hasOne:function(a,b,c){return u.prototype[a]=function(d){this.$relcache||(this.$relcache={});var e=this.$relcache[a];if(!e||d){var g=c.url||o.nestedUrl(this,c.alias||a,b,c),h=f(d)?d:null;this.$relcache[a]=e=b.$buildRaw(h,g,this)}return e},r[a]=function(b){this[a](b)},this},define:function(a,b){return f(a)?c(a,function(a,b){u.prototype[b]=a},this):u.prototype[a]=b,this},classDefine:function(a,b){return f(a)?c(a,function(a,b){this.classDefine(b,a)},this):v[a]=b,this},on:function(a,b){var c=t[a];return c||(c=t[a]=[]),c.push(b),this},beforeSave:function(a){return this.on("before_save",a)},beforeCreate:function(a){return this.on("before_create",a)},afterCreate:function(a){return this.on("after_create",a)},beforeUpdate:function(a){return this.on("before_update",a)},afterUpdate:function(a){return this.on("after_update",a)},afterSave:function(a){return this.on("after_save",a)},beforeDestroy:function(a){return this.on("before_destroy",a)},afterDestroy:function(a){return this.on("after_destroy",a)},afterFeed:function(a){return this.on("after_feed",a)},beforeRender:function(a){return this.on("before_render",a)}};return u.$meta=i.call(arguments,1),w.loadMeta(u.$meta),d(u,v),d(u.collection_proto,v),u}}]}}]);